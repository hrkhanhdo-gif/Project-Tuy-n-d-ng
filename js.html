<script>
    // GLOBAL STATE
    let currentUser = null;
    let candidatesData = [];
    let stagesData = [];

    // UTILITY FUNCTIONS
    function hashCode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash;
    }

    // 0. INITIALIZATION
    document.addEventListener('DOMContentLoaded', function () {
        // PERMANENT LOGIN BYPASS (Requested by User)
        currentUser = { username: 'admin', role: 'Admin', name: 'System Admin (Bypass)' };

        // Update UI immediately
        if (document.getElementById('current-user-display'))
            document.getElementById('current-user-display').innerText = currentUser.username;

        if (document.getElementById('login-screen'))
            document.getElementById('login-screen').style.display = 'none';

        if (document.getElementById('app-container'))
            document.getElementById('app-container').style.display = 'block';

        // Load Data
        updateUIForRole();
        loadDashboardData();

        // Alert if no DB
        if (!hasDB) {
            Swal.fire({
                title: 'Hệ thống chưa thiết lập!',
                text: 'Database chưa được kết nối. Bạn có muốn tự động tạo Database mới không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Tạo Database ngay',
                cancelButtonText: 'Để sau (Dùng thử)',
                confirmButtonColor: '#0D6EFD'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Assuming setupDatabase or performSetup exists
                    if (typeof performSetup === 'function') performSetup();
                    else if (typeof setupDatabase === 'function') setupDatabase();
                }
            });
        }
    });

    function checkSession() {
        const storedUser = localStorage.getItem('ats_user');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            // Auto Login UI
            document.getElementById('current-user-display').innerText = currentUser.username;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            updateUIForRole(); // Apply permissions
            loadDashboardData();
        }
    }

    function updateUIForRole() {
        const settingsLink = document.getElementById('nav-settings');
        if (currentUser && currentUser.role === 'Admin') {
            if (settingsLink) settingsLink.style.display = 'block';
        } else {
            if (settingsLink) settingsLink.style.display = 'none';
        }
    }

    // 1. SIMPLE NAVIGATION
    function showSection(sectionId, element) {
        // PERMISSION CHECK
        if (sectionId === 'settings' && (!currentUser || currentUser.role !== 'Admin')) {
            Swal.fire('Truy cập bị từ chối', 'Bạn không có quyền truy cập mục này.', 'error');
            return;
        }

        // Hide all sections
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        // Show target
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('active');
        } else {
            console.warn('Section not found:', sectionId);
        }

        // Update Sidebar Active State
        if (element) {
            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
            element.classList.add('active');

            // Update Header Title
            const titleMap = {
                'dashboard': 'Tổng Quan Hoạt Động',
                'kanban': 'Bảng Theo Dõi Ứng Viên (Kanban)',
                'candidates': 'Danh Sách Ứng Viên',
                'jobs': 'Quản Lý Vị Trí Tuyển Dụng',
                'settings': 'Cài Đặt Hệ Thống'
            };
            document.getElementById('page-title').innerText = titleMap[sectionId] || 'Trang Quản Trị';

            // Lazy Load Data
            if (sectionId === 'jobs') loadJobs();
            if (sectionId === 'settings') loadSettings();
            if (sectionId === 'candidates') renderCandidatesTable();
            if (sectionId === 'kanban') renderKanbanBoard();
            if (sectionId === 'dashboard') updateDashboardStats();
        }
    }

    // 2. LOGIN LOGIC
    function handleLogin() {
        let u = document.getElementById('login-username').value;
        let p = document.getElementById('login-password').value;

        if (u) u = u.trim();
        if (p) p = p.trim();

        const msg = document.getElementById('login-message');
        const loader = document.getElementById('login-loader');

        if (!u || !p) {
            msg.innerText = 'Vui lòng nhập đầy đủ thông tin.';
            return;
        }

        msg.innerText = '';
        loader.style.display = 'inline-block';

        google.script.run.withSuccessHandler(function (response) {
            loader.style.display = 'none';
            if (response.success) {
                currentUser = response.user;
                // Save Session
                localStorage.setItem('ats_user', JSON.stringify(currentUser));

                document.getElementById('current-user-display').innerText = currentUser.username;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';

                updateUIForRole(); // Apply Permissions
                // Load Initial Data
                loadDashboardData();
            } else {
                msg.innerText = response.message;
            }
        }).withFailureHandler(function (err) {
            loader.style.display = 'none';
            msg.innerText = 'Lỗi kết nối: ' + err.message;
        }).apiLogin(u, p);
    }

    function logout() {
        localStorage.removeItem('ats_user');
        location.reload();
    }

    // 3. LOAD DATA
    function loadDashboardData() {
        console.log('🔄 loadDashboardData() called');

        google.script.run
            .withSuccessHandler(function (data) {
                console.log('✅ SUCCESS HANDLER CALLED');
                console.log('Raw data:', data);

                // FALLBACK: If backend returns null, use sample data for UI demo
                if (!data || data === null) {
                    console.warn('⚠️ Backend returned null! Using sample data to demonstrate UI...');
                    data = {
                        candidates: [
                            {
                                ID: 'C001', Name: 'Hồ Quang Trường', Phone: '0868871680', Email: 'Quangtruong.ho@gmail.com',
                                Position: 'Marketing Executive', Department: 'Marketing', Status: 'Apply', Stage: 'Apply',
                                Contact_Status: 'Mới tiếp nhận', Source: 'Website', Applied_Date: '2026-02-13',
                                Recruiter: 'Admin', CV_Link: 'https://drive.google.com'
                            },
                            {
                                ID: 'C002', Name: 'Nguyễn Văn A', Phone: '0901234567', Email: 'nguyenvana@example.com',
                                Position: 'Java Developer', Department: 'IT', Status: 'Interview', Stage: 'Interview',
                                Contact_Status: 'Đã liên lạc', Source: 'LinkedIn', Applied_Date: '2026-02-12',
                                Recruiter: 'HR Manager', CV_Link: '#'
                            },
                            {
                                ID: 'C003', Name: 'Trần Thị B', Phone: '0907654321', Email: 'tranthib@example.com',
                                Position: 'Sales Manager', Department: 'Sales', Status: 'Offer', Stage: 'Offer',
                                Contact_Status: 'Đang trao đổi', Source: 'Referral', Applied_Date: '2026-02-10',
                                Recruiter: 'CEO', CV_Link: '#'
                            }
                        ],
                        stages: [
                            { ID: 'S1', Stage_Name: 'Apply', Order: 1, Color: '#0d6efd' },
                            { ID: 'S2', Stage_Name: 'Interview', Order: 2, Color: '#fd7e14' },
                            { ID: 'S3', Stage_Name: 'Offer', Order: 3, Color: '#198754' },
                            { ID: 'S4', Stage_Name: 'Rejected', Order: 4, Color: '#dc3545' }
                        ]
                    };
                }

                candidatesData = data.candidates || [];
                stagesData = data.stages || [];

                console.log('candidatesData:', candidatesData.length, 'items');
                console.log('stagesData:', stagesData.length, 'items');

                updateDashboardStats();
                renderKanbanBoard();
                renderCandidatesTable();
            })
            .withFailureHandler(function (error) {
                console.error('❌ FAILURE:', error);
                alert('Lỗi: ' + error.message);
            })
            .apiGetInitialData();
    }

    function updateDashboardStats() {
        document.getElementById('stat-total-candidates').innerText = candidatesData.length;

        // Calculate stats based on Status/Stage
        const hiredCount = candidatesData.filter(c => c.Status === 'Offer' || c.Status === 'Hired').length;
        const interviewCount = candidatesData.filter(c => c.Status === 'Interview' || c.Status === 'Phỏng vấn').length;
        const rejectedCount = candidatesData.filter(c => c.Status === 'Rejected' || c.Status === 'Loại').length;

        document.getElementById('stat-hired').innerText = hiredCount;
        document.getElementById('stat-interviewing').innerText = interviewCount;
        document.getElementById('stat-rejected').innerText = rejectedCount;

        // Update Chart if exists
        updateCharts();
    }

    function updateCharts() {
        // Group by Month (Created Date)
        const monthCounts = Array(12).fill(0);
        candidatesData.forEach(c => {
            if (c.Applied_Date) {
                const d = new Date(c.Applied_Date);
                if (!isNaN(d)) monthCounts[d.getMonth()]++;
            }
        });

        // We need to access the chart instance. 
        // Since we created it in DOMContentLoaded, let's attach it to window or re-create.
        // For simplicity, let's just trigger a re-render if the canvas exists and we have a global ref, 
        // or easier: just destroy and recreate if we can access the context.
        // Actually, let's look at the init code.
    }

    // 4. RENDER KANBAN
    function renderKanbanBoard() {
        const container = document.getElementById('kanban-container');

        // Show loading indicator
        const loadingIndicator = document.getElementById('kanban-loading');
        if (loadingIndicator) loadingIndicator.style.display = 'block';

        // Clear container (keeping loading indicator)
        Array.from(container.children).forEach(child => {
            if (child.id !== 'kanban-loading') child.remove();
        });

        // DEDUPLICATE candidatesData by ID before rendering
        const seen = new Set();
        const uniqueCandidates = candidatesData.filter(c => {
            if (seen.has(c.ID)) {
                console.warn('Duplicate candidate removed:', c.ID, c.Name);
                return false;
            }
            seen.add(c.ID);
            return true;
        });

        // Debug: Log data
        console.log('=== KANBAN BOARD DEBUG ===');
        console.log('Total Candidates (before dedup):', candidatesData.length);
        console.log('Total Candidates (after dedup):', uniqueCandidates.length);
        console.log('Total Stages:', stagesData.length);

        // Sort stages by order
        stagesData.sort((a, b) => a.Order - b.Order);

        // Use document fragment for batch DOM update (FASTER!)
        const fragment = document.createDocumentFragment();

        stagesData.forEach(stage => {
            const col = document.createElement('div');
            col.className = 'kanban-column';
            col.innerHTML = `
         <div class="kanban-header" style="border-bottom-color: ${stage.Color || '#ccc'}">
             <span>${stage.Stage_Name}</span>
             <span class="badge bg-secondary rounded-pill count-badge">0</span>
         </div>
         <div class="kanban-items" data-stage="${stage.Stage_Name}">
           <!-- Items go here -->
         </div>
       `;

            // Append to fragment instead of container (FASTER!)
            fragment.appendChild(col);

            // Filter candidates for this stage
            // Try both Status and Stage fields, case-insensitive
            const candidatesInStage = uniqueCandidates.filter(c => {
                const candidateStatus = (c.Status || '').toString().trim();
                const candidateStage = (c.Stage || '').toString().trim();
                const stageName = stage.Stage_Name.toString().trim();

                return candidateStatus.toLowerCase() === stageName.toLowerCase() ||
                    candidateStage.toLowerCase() === stageName.toLowerCase();
            });

            const itemsContainer = col.querySelector('.kanban-items');
            col.querySelector('.count-badge').innerText = candidatesInStage.length;

            // Debug logging
            if (candidatesInStage.length > 0) {
                console.log(`Stage "${stage.Stage_Name}" has ${candidatesInStage.length} candidates:`, candidatesInStage);
            }

            candidatesInStage.forEach(c => {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.setAttribute('data-id', c.ID);
                card.style.cursor = 'pointer';

                // Generate avatar initials
                const initials = (c.Name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const avatarColors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c'];
                const avatarColor = avatarColors[Math.abs(hashCode(c.ID || '')) % avatarColors.length];

                // Determine status badge
                let statusBadge = '';
                if (c.Contact_Status) {
                    const badgeColors = {
                        'Mới tiếp nhận': 'primary',
                        'Đã liên lạc': 'success',
                        'Chờ phản hồi': 'warning',
                        'Đang trao đổi': 'info'
                    };
                    const badgeClass = badgeColors[c.Contact_Status] || 'secondary';
                    statusBadge = `<span class="badge bg-${badgeClass} ms-2" style="font-size: 0.7rem;">${c.Contact_Status}</span>`;
                }

                card.innerHTML = `
                    <div class="d-flex align-items-start mb-2">
                        <div class="candidate-avatar me-2" style="background: ${avatarColor}; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                            ${initials}
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-bold" style="font-size: 0.95rem;">${c.Name || 'N/A'}</h6>
                            ${statusBadge}
                        </div>
                    </div>
                    <p class="mb-1 small text-muted"><i class="fas fa-briefcase me-1"></i>${c.Position || 'N/A'}</p>
                    <p class="mb-1 small text-muted"><i class="fas fa-envelope me-1"></i>${c.Email || 'N/A'}</p>
                    <p class="mb-1 small text-muted"><i class="fas fa-phone me-1"></i>${c.Phone || 'N/A'}</p>
                    ${c.Recruiter ? `<p class="mb-2 small text-muted"><i class="fas fa-user-tie me-1"></i>${c.Recruiter}</p>` : ''}
                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2" style="border-top: 1px solid #eee;">
                        <small class="text-muted">${c.Applied_Date ? new Date(c.Applied_Date).toLocaleDateString('vi-VN') : ''}</small>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary btn-sm p-1" title="Gửi email" onclick="event.stopPropagation(); window.location.href='mailto:${c.Email}';">
                                <i class="fas fa-envelope" style="font-size: 0.75rem;"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm p-1" title="Xem chi tiết" onclick="event.stopPropagation(); openCandidateDetail('${c.ID}');">
                                <i class="fas fa-eye" style="font-size: 0.75rem;"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm p-1" title="Sửa" onclick="event.stopPropagation(); editCandidate('${c.ID}');">
                                <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm p-1" title="Xóa" onclick="event.stopPropagation(); deleteCandidate('${c.ID}');">
                                <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Prevent click when dragging
                let isDragging = false;
                card.addEventListener('mousedown', () => { isDragging = false; });
                card.addEventListener('mousemove', () => { isDragging = true; });

                // Click on card to open detail (only if not dragging AND not clicking on buttons)
                card.addEventListener('mouseup', function (e) {
                    // Check if click is on a button or inside button group
                    const clickedOnButton = e.target.closest('button') || e.target.closest('.btn-group');

                    if (!isDragging && !clickedOnButton) {
                        setTimeout(() => openCandidateDetail(c.ID), 100);
                    }
                    isDragging = false;
                });

                itemsContainer.appendChild(card);
            });

            // Init Sortable for this column
            if (typeof Sortable === 'undefined') {
                console.error('❌ Sortable library not loaded!');
            } else {
                console.log(`✅ Initializing Sortable for stage: ${stage.Stage_Name}`);
                new Sortable(itemsContainer, {
                    group: 'kanban-shared',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    forceFallback: true,
                    fallbackClass: 'sortable-fallback',
                    fallbackOnBody: true,
                    swapThreshold: 0.65,
                    onStart: function (evt) {
                        console.log('🚀 Drag started');
                        evt.item.style.opacity = '0.5';
                    },
                    onEnd: function (evt) {
                        evt.item.style.opacity = '1';

                        const itemEl = evt.item;
                        const newStage = evt.to.getAttribute('data-stage');
                        const candidateId = itemEl.getAttribute('data-id');
                        const oldStage = evt.from.getAttribute('data-stage');

                        console.log('🔄 Drag ended - From:', oldStage, 'To:', newStage, 'ID:', candidateId);

                        // Only update if stage actually changed
                        if (newStage && candidateId && newStage !== oldStage) {
                            console.log('💾 Saving change to backend...');
                            google.script.run.withSuccessHandler(function (res) {
                                if (!res.success) {
                                    Swal.fire('Lỗi', res.message, 'error');
                                    // Revert if failed
                                    loadDashboardData();
                                } else {
                                    // Update local data
                                    const c = candidatesData.find(x => x.ID == candidateId);
                                    if (c) {
                                        c.Status = newStage;
                                        c.Stage = newStage;
                                        updateDashboardStats();
                                    }
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Đã cập nhật!',
                                        text: `Đã chuyển sang ${newStage}`,
                                        timer: 1500,
                                        showConfirmButton: false
                                    });
                                }
                            }).withFailureHandler(function (error) {
                                console.error('Error updating status:', error);
                                Swal.fire('Lỗi', 'Không thể cập nhật: ' + error.message, 'error');
                                // Revert on error
                                loadDashboardData();
                            }).apiUpdateCandidateStatus(candidateId, newStage);
                        } else {
                            console.log('⏭️ Stage unchanged, no update needed');
                        }
                    }
                });
            }
        });

        // Append entire fragment to DOM at once (SINGLE REFLOW - MUCH FASTER!)
        container.appendChild(fragment);

        // Hide loading indicator
        if (loadingIndicator) loadingIndicator.style.display = 'none';
    }

    function renderCandidatesTable() {
        const tbody = document.querySelector('#candidates-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Use document fragment for batch DOM update
        const fragment = document.createDocumentFragment();

        candidatesData.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
           <td>${c.ID}</td>
           <td class="fw-bold cursor-pointer text-primary" onclick="openCandidateDetail('${c.ID}')">${c.Name}</td>
           <td>${c.Position}</td>
           <td>${c.Applied_Date ? c.Applied_Date.slice(0, 10) : ''}</td>
           <td><span class="badge bg-info text-dark">${c.Status}</span></td>
           <td>
             <button class="btn btn-sm btn-outline-primary" onclick="openCandidateDetail('${c.ID}')"><i class="fas fa-eye"></i></button>
           </td>
        `;
            fragment.appendChild(tr);
        });

        // Append all at once
        tbody.appendChild(fragment);
    }

    // 9. CANDIDATE DETAILS
    function openCandidateDetail(id) {
        console.log('Opening candidate detail for ID:', id);
        const c = candidatesData.find(x => x.ID == id);

        if (!c) {
            console.error('Candidate not found:', id);
            Swal.fire('Lỗi', 'Không tìm thấy ứng viên', 'error');
            return;
        }

        console.log('Candidate data:', c);
        const modal = document.getElementById('candidateDetailModal');

        // Set hidden ID field
        modal.querySelector('#current-candidate-id').value = c.ID || '';

        // Populate department dropdown first, then position
        populateDepartmentDropdown(c.Department, function () {
            populatePositionDropdown(c.Position);
        });

        // Populate all other detail fields
        modal.querySelector('#detail-name').value = c.Name || '';
        modal.querySelector('#detail-phone').value = c.Phone || '';
        modal.querySelector('#detail-email').value = c.Email || '';
        modal.querySelector('#detail-experience').value = c.Experience || '';
        modal.querySelector('#detail-education').value = c.Education || '';
        modal.querySelector('#detail-salary').value = c.Expected_Salary || '';
        modal.querySelector('#detail-source').value = c.Source || '';
        modal.querySelector('#detail-recruiter').value = c.Recruiter || '';
        populateStatusDropdown(c.Status || c.Stage);  // Populate from stagesData
        modal.querySelector('#detail-contact-status').value = c.Contact_Status || '';
        modal.querySelector('#detail-notes').value = c.Notes || '';

        // CV Link
        const cvLink = modal.querySelector('#detail-cv-link');
        if (cvLink) {
            cvLink.value = c.CV_Link || '';
        }

        new bootstrap.Modal(modal).show();
    }

    function saveCandidateUpdates() {
        const form = document.getElementById('edit-candidate-form');
        const data = {
            ID: form.querySelector('[name="id"]').value,
            Name: form.querySelector('[name="name"]').value,
            Email: form.querySelector('[name="email"]').value,
            Phone: form.querySelector('[name="phone"]').value,
            Position: form.querySelector('[name="position"]').value,
            Status: form.querySelector('[name="stage"]').value,
            Stage: form.querySelector('[name="stage"]').value
        };

        const btn = document.querySelector('#candidateDetailModal .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = 'Đang lưu...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function (res) {
            btn.innerText = originalText;
            btn.disabled = false;
            if (res.success) {
                Swal.fire('Thành công', 'Đã cập nhật thông tin', 'success');
                bootstrap.Modal.getInstance(document.getElementById('candidateDetailModal')).hide();

                // Update Local Data
                candidatesData = res.data.candidates;
                stagesData = res.data.stages; // refresh all

                renderCandidatesTable();
                renderKanbanBoard();
                updateDashboardStats();
            } else {
                Swal.fire('Lỗi', res.message, 'error');
            }
        }).apiUpdateCandidate(data);
    }


    // 5. INIT CHARTS
    let recruitmentChartInstance = null;
    let sourceChartInstance = null;

    document.addEventListener('DOMContentLoaded', function () {
        initCharts();
    });

    function initCharts() {
        if (document.getElementById('recruitmentChart')) {
            const ctx1 = document.getElementById('recruitmentChart').getContext('2d');
            recruitmentChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Ứng tuyển theo tháng',
                        data: Array(12).fill(0), // Init empty
                        borderColor: '#FFC107',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(255, 193, 7, 0.1)'
                    }]
                },
                options: { responsive: true }
            });
        }

        // Ensure Source Chart also exists (if added in HTML)
        if (document.getElementById('sourceChart')) {
            const ctx2 = document.getElementById('sourceChart').getContext('2d');
            sourceChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Website', 'LinkedIn', 'Facebook', 'Referral', 'Other'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#FFC107', '#0D6EFD', '#198754', '#DC3545', '#6C757D']
                    }]
                }
            });
        }
    }

    // Update data for chart
    function updateCharts() {
        if (!recruitmentChartInstance) return;

        // 1. Line Chart Data
        const monthCounts = Array(12).fill(0);
        candidatesData.forEach(c => {
            if (c.Applied_Date) {
                const dateParts = c.Applied_Date.split('T')[0].split('-'); // YYYY-MM-DD
                if (dateParts.length === 3) {
                    const month = parseInt(dateParts[1], 10) - 1; // 0-indexed
                    if (month >= 0 && month <= 11) monthCounts[month]++;
                }
            }
        });

        recruitmentChartInstance.data.datasets[0].data = monthCounts;
        recruitmentChartInstance.update();

        // 2. Source Chart Data (if implemented)
        if (sourceChartInstance) {
            const sources = { 'Website': 0, 'LinkedIn': 0, 'Facebook': 0, 'Referral': 0, 'Other': 0 };
            candidatesData.forEach(c => {
                let s = c.Source || 'Other';
                if (sources.hasOwnProperty(s)) sources[s]++;
                else sources['Other']++;
            });
            sourceChartInstance.data.datasets[0].data = Object.values(sources);
            sourceChartInstance.update();
        }
    }


    // 6. SAVE CANDIDATE
    // 6. SAVE CANDIDATE
    function saveCandidate() {
        // Collect all data from new full form
        const data = {
            name: document.getElementById('add-name').value,
            phone: document.getElementById('add-phone').value,
            email: document.getElementById('add-email').value,
            department: document.getElementById('add-department').value,
            position: document.getElementById('add-position').value,
            experience: document.getElementById('add-experience').value,
            education: document.getElementById('add-education').value,
            expected_salary: document.getElementById('add-salary').value,
            source: document.getElementById('add-source').value,
            recruiter: document.getElementById('add-recruiter').value,
            contact_status: document.getElementById('add-contact-status').value,
            status: document.getElementById('add-status').value,
            notes: document.getElementById('add-notes').value
        };

        // Validate required fields
        if (!data.name) {
            Swal.fire('Lỗi', 'Vui lòng điền tên ứng viên', 'error');
            return;
        }
        if (!data.department) {
            Swal.fire('Lỗi', 'Vui lòng chọn phòng ban', 'error');
            return;
        }
        if (!data.position) {
            Swal.fire('Lỗi', 'Vui lòng chọn vị trí', 'error');
            return;
        }

        const fileInput = document.getElementById('add-cv-file');
        const file = fileInput ? fileInput.files[0] : null;

        const btn = document.querySelector('#addCandidateModal .btn-primary-custom');
        const originalText = btn.innerText;
        btn.innerText = 'Đang lưu...';
        btn.disabled = true;

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const result = e.target.result; // data:application/pdf;base64,...
                const base64 = result.split(',')[1];
                const fileData = {
                    name: file.name,
                    type: file.type,
                    data: base64
                };

                sendToBackend(data, fileData);
            };
            reader.readAsDataURL(file);
        } else {
            sendToBackend(data, null);
        }

        function sendToBackend(formData, fileData) {
            google.script.run.withSuccessHandler(function (response) {
                btn.innerText = originalText;
                btn.disabled = false;

                if (response.success) {
                    Swal.fire({
                        title: 'Thành công!',
                        text: response.message,
                        icon: 'success',
                        confirmButtonColor: '#FFC107'
                    });

                    // Close modal
                    const myModal = bootstrap.Modal.getInstance(document.getElementById('addCandidateModal'));
                    if (myModal) myModal.hide();
                    form.reset();
                    if (document.getElementById('cv-file')) document.getElementById('cv-file').value = '';

                    // Reload all data from backend
                    loadCandidates();

                } else {
                    Swal.fire('Lỗi', response.message, 'error');
                }
            }).withFailureHandler(function (err) {
                btn.innerText = originalText;
                btn.disabled = false;
                Swal.fire('Lỗi hệ thống', err.message, 'error');
            }).apiCreateCandidate(formData, fileData);
        }
    }

    // 7. JOB MANAGEMENT
    let jobsData = [];

    function loadJobs() {
        google.script.run.withSuccessHandler(function (data) {
            jobsData = data;
            renderJobsTable();
        }).apiGetJobs();
    }

    function renderJobsTable() {
        const tbody = document.querySelector('#jobs-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        if (jobsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Chưa có tin tuyển dụng nào.</td></tr>';
            return;
        }

        jobsData.forEach(j => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><small class="text-muted">${j.ID}</small></td>
                <td class="fw-bold">${j.Title}</td>
                <td><span class="badge bg-light text-dark border">${j.Department}</span></td>
                <td>${j.Location}</td>
                <td>${j.Created_Date ? j.Created_Date.slice(0, 10) : ''}</td>
                <td><span class="badge bg-success">${j.Status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" title="Sửa"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" title="Xóa"><i class="fas fa-trash"></i></button>
                </td>
             `;
            tbody.appendChild(tr);
        });
    }

    function saveJob() {
        const form = document.getElementById('add-job-form');
        const data = {};
        data.title = form.querySelector('[name="title"]').value;
        data.department = form.querySelector('[name="department"]').value;
        data.location = form.querySelector('[name="location"]').value;
        data.type = form.querySelector('[name="type"]').value;
        data.description = form.querySelector('[name="description"]').value;

        if (!data.title) {
            Swal.fire('Lỗi', 'Vui lòng nhập tiêu đề', 'error');
            return;
        }

        const btn = document.querySelector('#addJobModal .btn-primary-custom');
        const originalText = btn.innerText;
        btn.innerText = 'Đang lưu...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function (res) {
            btn.innerText = originalText;
            btn.disabled = false;
            if (res.success) {
                Swal.fire('Thành công', 'Đã tạo tin tuyển dụng', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                form.reset();
                loadJobs();
            } else {
                Swal.fire('Lỗi', res.message, 'error');
            }
        }).apiCreateJob(data);
    }

    // 8. SETTINGS MANAGEMENT
    function loadSettings() {
        google.script.run.withSuccessHandler(renderSettings).apiGetSettings();
        loadEmailTemplates();
    }

    // ... (renderSettings exists) ...

    let emailTemplatesData = [];
    function loadEmailTemplates() {
        google.script.run.withSuccessHandler(function (data) {
            emailTemplatesData = data;
            const list = document.getElementById('email-template-list');
            if (!list) return;
            list.innerHTML = '';

            emailTemplatesData.forEach(t => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerText = t.Name;
                item.onclick = (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#email-template-list a').forEach(a => a.classList.remove('active'));
                    item.classList.add('active');
                    selectTemplate(t.ID);
                };
                list.appendChild(item);
            });
        }).apiGetEmailTemplates();
    }

    function selectTemplate(id) {
        const t = emailTemplatesData.find(x => x.ID == id);
        if (!t) return;

        document.getElementById('template-editor-title').innerText = 'Đang sửa: ' + t.Name;
        document.getElementById('email-template-form').style.display = 'block';
        document.getElementById('tpl-id').value = t.ID;
        document.getElementById('tpl-subject').value = t.Subject;
        document.getElementById('tpl-body').value = t.Body;
    }

    function saveEmailTemplate() {
        const data = {
            id: document.getElementById('tpl-id').value,
            subject: document.getElementById('tpl-subject').value,
            body: document.getElementById('tpl-body').value
        };

        const btn = document.querySelector('#email-template-form button');
        const text = btn.innerText;
        btn.innerText = 'Đang lưu...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function (res) {
            btn.innerText = text;
            btn.disabled = false;
            if (res.success) Swal.fire('Thành công', 'Đã lưu mẫu email', 'success');
            else Swal.fire('Lỗi', res.message, 'error');
        }).apiSaveEmailTemplate(data);
    }

    function renderSettings(data) {
        // Users Table
        const userTbody = document.querySelector('#users-table tbody');
        if (userTbody) {
            userTbody.innerHTML = '';
            data.users.forEach(u => {
                userTbody.innerHTML += `
                    <tr>
                        <td>${u.Username}</td>
                        <td>${u.Full_Name}</td>
                        <td>${u.Role}</td>
                        <td>${u.Department}</td>
                        <td>
                             <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.Username}')">Xóa</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Stages List
        const stagesContainer = document.getElementById('stages-config-list');
        if (stagesContainer) {
            stagesContainer.innerHTML = '';
            // If specific data passed, use it, else use global stagesData
            const list = (data.stages && data.stages.length > 0) ? data.stages : stagesData;

            list.sort((a, b) => a.Order - b.Order).forEach(s => {
                addStageConfigRow(s.Stage_Name, s.Color);
            });
        }
    }

    function addStageConfigRow(name = '', color = '#0d6efd') {
        const container = document.getElementById('stages-config-list');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center mb-2 p-2 border rounded stage-row';
        div.innerHTML = `
            <span class="me-3 fw-bold handle"><i class="fas fa-grip-lines text-muted"></i></span>
            <input type="text" class="form-control me-2" placeholder="Tên bước (Ví dụ: Phỏng vấn)" value="${name}">
            <input type="color" class="form-control form-control-color me-2" value="${color}">
            <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(div);

        // Init sortable if needed (optional)
    }

    function saveStagesConfig() {
        const rows = document.querySelectorAll('.stage-row');
        const newStages = [];

        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input');
            const name = inputs[0].value.trim();
            if (name) {
                newStages.push({
                    ID: 'S' + new Date().getTime() + index, // Simple ID gen
                    Stage_Name: name,
                    Order: index + 1,
                    Color: inputs[1].value
                });
            }
        });

        if (newStages.length === 0) {
            Swal.fire('Lỗi', 'Cần ít nhất 1 bước trong quy trình', 'error');
            return;
        }

        const btn = document.querySelector('#tab-stages .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = 'Đang lưu...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function (res) {
            btn.innerText = originalText;
            btn.disabled = false;

            if (res.success) {
                Swal.fire('Thành công', 'Đã lưu cấu hình quy trình', 'success');
                stagesData = newStages; // Update local
                refreshAllDropdowns();  // NEW - refresh status dropdowns everywhere
                // Refresh Kanban & Settings UI
                renderKanbanBoard();
                // Re-render settings to show saved state
                renderSettings({ users: [], stages: newStages }); // Hacky partial update or reload all
            } else {
                Swal.fire('Lỗi', res.message, 'error');
            }
        }).apiSaveStages(newStages);
    }

    function saveNewUser() {
        const form = document.getElementById('add-user-form');
        const user = {
            username: form.querySelector('[name="username"]').value,
            password: form.querySelector('[name="password"]').value,
            fullname: form.querySelector('[name="fullname"]').value,
            email: form.querySelector('[name="email"]').value,
            role: form.querySelector('[name="role"]').value,
            department: form.querySelector('[name="department"]').value
        };

        if (!user.username || !user.password) {
            Swal.fire('Lỗi', 'Vui lòng điền đầy đủ thông tin', 'error');
            return;
        }

        google.script.run.withSuccessHandler(function (res) {
            if (res.success) {
                Swal.fire('Thành công', 'Đã thêm người dùng', 'success');
                form.reset();
                loadSettings();
            } else {
                Swal.fire('Lỗi', res.message, 'error');
            }
        }).apiCreateUser(user);
    }

    function deleteUser(username) {
        if (!confirm('Bạn có chắc muốn xóa user này?')) return;
        google.script.run.withSuccessHandler(function (res) {
            if (res.success) loadSettings();
            else Swal.fire('Lỗi', res.message, 'error');
        }).apiDeleteUser(username);
    }

    // CANDIDATE DETAIL & MANAGEMENT FUNCTIONS (openCandidateDetail is defined earlier at line ~510)


    function editCandidate(candidateId) {
        openCandidateDetail(candidateId);
    }

    function deleteCandidate(candidateId) {
        Swal.fire({
            title: 'Xác nhận xóa?',
            text: 'Bạn có chắc muốn xóa ứng viên này?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Call API to delete
                google.script.run.withSuccessHandler(function (res) {
                    if (res.success) {
                        Swal.fire('Đã xóa!', 'Ứng viên đã được xóa.', 'success');
                        loadDashboardData(); // Reload data
                    } else {
                        Swal.fire('Lỗi', res.message, 'error');
                    }
                }).apiDeleteCandidate(candidateId);
            }
        });
    }

    function saveCandidateDetail() {
        const modalEl = document.getElementById('candidateDetailModal');
        const candidateId = modalEl.querySelector('#current-candidate-id').value;

        if (!candidateId) {
            Swal.fire('Lỗi', 'Không tìm thấy ID ứng viên', 'error');
            console.error('Missing candidate ID');
            return;
        }

        // Build updated data with EXACT field names matching Sheet headers
        const updatedData = {
            ID: candidateId,  // Must be uppercase to match Sheet!
            Name: modalEl.querySelector('#detail-name').value,
            Phone: modalEl.querySelector('#detail-phone').value,
            Email: modalEl.querySelector('#detail-email').value,
            Position: modalEl.querySelector('#detail-position').value,
            Department: modalEl.querySelector('#detail-department').value,
            Experience: modalEl.querySelector('#detail-experience').value,
            Education: modalEl.querySelector('#detail-education').value,
            Expected_Salary: modalEl.querySelector('#detail-salary').value,
            Source: modalEl.querySelector('#detail-source').value,
            Recruiter: modalEl.querySelector('#detail-recruiter').value,
            Status: modalEl.querySelector('#detail-status').value,
            Stage: modalEl.querySelector('#detail-status').value, // Sync Stage with Status
            Contact_Status: modalEl.querySelector('#detail-contact-status').value,
            Notes: modalEl.querySelector('#detail-notes').value
        };

        console.log('Saving candidate with ID:', candidateId);
        console.log('Updated data:', updatedData);

        google.script.run
            .withSuccessHandler(function (res) {
                console.log('Save response:', res);

                if (res.success) {
                    // Update local data
                    if (res.data) {
                        candidatesData = res.data.candidates || candidatesData;
                        stagesData = res.data.stages || stagesData;
                    }

                    // Refresh UI
                    updateDashboardStats();
                    renderKanbanBoard();
                    renderCandidatesTable();

                    // FORCE CLOSE MODAL AND REMOVE BACKDROP
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();

                    // Clean up any stuck backdrops
                    setTimeout(() => {
                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 300);

                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Đã cập nhật thông tin ứng viên',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Lỗi', res.message || 'Không thể cập nhật', 'error');
                }
            })
            .withFailureHandler(function (error) {
                console.error('Save failed:', error);
                Swal.fire('Lỗi', 'Không thể kết nối: ' + error.message, 'error');
            })
            .apiUpdateCandidate(updatedData);
    }

    // ============================================
    // DEPARTMENT & POSITION MANAGEMENT
    // ============================================

    let departmentsData = [];

    function loadDepartments() {
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.success) {
                    departmentsData = res.departments || [];
                    renderDepartments();
                } else {
                    console.error('Failed to load departments:', res.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Failed to load departments:', error);
            })
            .apiGetDepartments();
    }

    function renderDepartments() {
        const container = document.getElementById('departments-container');
        if (!container) return;

        container.innerHTML = '';

        departmentsData.forEach(dept => {
            const card = document.createElement('div');
            card.className = 'col-md-4';

            const positionsList = dept.positions.map(pos => `
                <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>${pos}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="promptEditPosition('${dept.name}', '${pos}')" title="Sửa">
                            <i class="fas fa-edit" style="font-size: 0.7rem;"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePosition('${dept.name}', '${pos}')" title="Xóa">
                            <i class="fas fa-trash" style="font-size: 0.7rem;"></i>
                        </button>
                    </div>
                </li>
            `).join('');

            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${dept.name}</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-1" onclick="promptEditDepartment('${dept.name}')" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="deleteDepartment('${dept.name}')" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            ${positionsList || '<li class="list-group-item text-muted">Chưa có vị trí</li>'}
                        </ul>
                    </div>
                    <div class="card-footer bg-white">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="promptAddPosition('${dept.name}')">
                            <i class="fas fa-plus"></i> Thêm vị trí
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(card);
        });
    }

    function promptAddDepartment() {
        Swal.fire({
            title: 'Thêm Phòng ban mới',
            input: 'text',
            inputPlaceholder: 'Nhập tên phòng ban...',
            showCancelButton: true,
            confirmButtonText: 'Thêm',
            cancelButtonText: 'Hủy',
            inputValidator: (value) => {
                if (!value) {
                    return 'Vui lòng nhập tên phòng ban!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                addDepartment(result.value);
            }
        });
    }

    function addDepartment(deptName) {
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.success) {
                    Swal.fire('Thành công!', 'Đã thêm phòng ban', 'success');
                    loadDepartments(); // Reload
                    refreshAllDropdowns();  // Auto-refresh dropdowns
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            })
            .withFailureHandler(function (error) {
                Swal.fire('Lỗi', error.message, 'error');
            })
            .apiAddDepartment(deptName);
    }

    function promptAddPosition(deptName) {
        Swal.fire({
            title: 'Thêm Vị trí mới',
            text: `Phòng ban: ${deptName}`,
            input: 'text',
            inputPlaceholder: 'Nhập tên vị trí...',
            showCancelButton: true,
            confirmButtonText: 'Thêm',
            cancelButtonText: 'Hủy',
            inputValidator: (value) => {
                if (!value) {
                    return 'Vui lòng nhập tên vị trí!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                addPosition(deptName, result.value);
            }
        });
    }

    function addPosition(deptName, position) {
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.success) {
                    Swal.fire('Thành công!', 'Đã thêm vị trí', 'success');
                    loadDepartments(); // Reload
                    refreshAllDropdowns();  // Auto-refresh dropdowns
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            })
            .withFailureHandler(function (error) {
                Swal.fire('Lỗi', error.message, 'error');
            })
            .apiAddPosition(deptName, position);
    }

    function deleteDepartment(deptName) {
        Swal.fire({
            title: 'Xác nhận xóa phòng ban?',
            text: `Bạn có chắc muốn xóa "${deptName}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                google.script.run
                    .withSuccessHandler(function (res) {
                        if (res.success) {
                            Swal.fire('Đã xóa!', 'Phòng ban đã được xóa', 'success');
                            loadDepartments();
                            refreshAllDropdowns();  // Auto-refresh dropdowns
                        } else {
                            Swal.fire('Lỗi', res.message, 'error');
                        }
                    })
                    .withFailureHandler(function (error) {
                        Swal.fire('Lỗi', error.message, 'error');
                    })
                    .apiDeleteDepartment(deptName);
            }
        });
    }

    function deletePosition(deptName, position) {
        Swal.fire({
            title: 'Xác nhận xóa vị trí?',
            text: `Bạn có chắc muốn xóa "${position}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                google.script.run
                    .withSuccessHandler(function (res) {
                        if (res.success) {
                            Swal.fire('Đã xóa!', 'Vị trí đã được xóa', 'success');
                            loadDepartments();
                            refreshAllDropdowns();  // Auto-refresh dropdowns
                        } else {
                            Swal.fire('Lỗi', res.message, 'error');
                        }
                    })
                    .withFailureHandler(function (error) {
                        Swal.fire('Lỗi', error.message, 'error');
                    })
                    .apiDeletePosition(deptName, position);
            }
        });
    }

    // EDIT DEPARTMENT
    function promptEditDepartment(oldName) {
        Swal.fire({
            title: 'Sửa tên phòng ban',
            input: 'text',
            inputValue: oldName,
            inputPlaceholder: 'Nhập tên mới',
            showCancelButton: true,
            confirmButtonText: 'Lưu',
            cancelButtonText: 'Hủy',
            preConfirm: (newName) => {
                if (!newName) {
                    Swal.showValidationMessage('Vui lòng nhập tên phòng ban');
                }
                return newName;
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                editDepartment(oldName, result.value);
            }
        });
    }

    function editDepartment(oldName, newName) {
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.success) {
                    Swal.fire('Đã cập nhật!', 'Tên phòng ban đã được cập nhật', 'success');
                    loadDepartments();
                    refreshAllDropdowns();  // Auto-refresh dropdowns
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            })
            .withFailureHandler(function (error) {
                Swal.fire('Lỗi', error.message, 'error');
            })
            .apiEditDepartment(oldName, newName);
    }

    // EDIT POSITION
    function promptEditPosition(deptName, oldPosition) {
        Swal.fire({
            title: 'Sửa tên vị trí',
            text: `Phòng ban: ${deptName}`,
            input: 'text',
            inputValue: oldPosition,
            inputPlaceholder: 'Nhập tên mới',
            showCancelButton: true,
            confirmButtonText: 'Lưu',
            cancelButtonText: 'Hủy',
            preConfirm: (newPosition) => {
                if (!newPosition) {
                    Swal.showValidationMessage('Vui lòng nhập tên vị trí');
                }
                return newPosition;
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                editPosition(deptName, oldPosition, result.value);
            }
        });
    }

    function editPosition(deptName, oldPosition, newPosition) {
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.success) {
                    Swal.fire('Đã cập nhật!', 'Tên vị trí đã được cập nhật', 'success');
                    loadDepartments();
                    refreshAllDropdowns();  // Auto-refresh dropdowns
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            })
            .withFailureHandler(function (error) {
                Swal.fire('Lỗi', error.message, 'error');
            })
            .apiEditPosition(deptName, oldPosition, newPosition);
    }

    // REFRESH ALL DROPDOWNS (called after any Settings change)
    function refreshAllDropdowns() {
        console.log('Refreshing all dropdowns...');

        // Refresh Kanban filter dropdowns
        populateFilterDropdowns();

        // Refresh candidate detail modal dropdowns (if modal is open)
        const detailModal = document.getElementById('candidateDetailModal');
        if (detailModal && detailModal.classList.contains('show')) {
            const currentDept = document.getElementById('detail-department')?.value;
            const currentPos = document.getElementById('detail-position')?.value;
            const currentStatus = document.getElementById('detail-status')?.value;

            populateDepartmentDropdown(currentDept, () => {
                populatePositionDropdown(currentPos);
            });
            populateStatusDropdown(currentStatus);  // NEW - refresh status dropdown
        }

        // Refresh add candidate modal dropdowns (if modal is open)
        const addModal = document.getElementById('addCandidateModal');
        if (addModal && addModal.classList.contains('show')) {
            const currentDept = document.getElementById('add-department')?.value;
            const currentStatus = document.getElementById('add-status')?.value;

            // Populate add-department dropdown directly (populateDepartmentDropdown only works for detail-department)
            const addDeptDropdown = document.getElementById('add-department');
            if (addDeptDropdown && departmentsData.length > 0) {
                addDeptDropdown.innerHTML = '<option value="">Chọn phòng ban</option>';
                departmentsData.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    if (dept.name === currentDept) option.selected = true;
                    addDeptDropdown.appendChild(option);
                });
                if (currentDept) {
                    populateAddPositionDropdown();
                }
            }
            populateAddStatusDropdown(currentStatus);  // NEW - refresh status dropdown
        }
    }

    // POPULATE STATUS DROPDOWN (Detail Modal)
    function populateStatusDropdown(selectedStatus) {
        const statusDropdown = document.getElementById('detail-status');
        if (!statusDropdown) return;

        statusDropdown.innerHTML = '<option value="">Chọn giai đoạn</option>';

        if (stagesData && stagesData.length > 0) {
            // Sort by order
            const sorted = [...stagesData].sort((a, b) => (a.Order || 0) - (b.Order || 0));
            sorted.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage.Stage_Name;
                option.textContent = stage.Stage_Name;
                if (stage.Stage_Name === selectedStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });
        } else {
            // Fallback to default stages if no custom stages defined
            const defaultStages = ['Apply', 'Call Interview', 'Interview', 'Offer', 'Hired', 'Rejected'];
            defaultStages.forEach(stageName => {
                const option = document.createElement('option');
                option.value = stageName;
                option.textContent = stageName;
                if (stageName === selectedStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });
        }
    }

    // POPULATE STATUS DROPDOWN (Add Candidate Modal)
    function populateAddStatusDropdown(selectedStatus) {
        const statusDropdown = document.getElementById('add-status');
        if (!statusDropdown) return;

        statusDropdown.innerHTML = '<option value="">Chọn giai đoạn</option>';

        if (stagesData && stagesData.length > 0) {
            // Sort by order
            const sorted = [...stagesData].sort((a, b) => (a.Order || 0) - (b.Order || 0));
            sorted.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage.Stage_Name;
                option.textContent = stage.Stage_Name;
                if (stage.Stage_Name === selectedStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });
        } else {
            // Fallback to default stages
            const defaultStages = ['Apply', 'Call Interview', 'Interview', 'Offer'];
            defaultStages.forEach(stageName => {
                const option = document.createElement('option');
                option.value = stageName;
                option.textContent = stageName;
                if (stageName === selectedStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });
        }
    }

    // Load departments when Settings tab is shown
    document.addEventListener('shown.bs.tab', function (e) {
        if (e.target.getAttribute('href') === '#tab-departments') {
            loadDepartments();
        }
    });

    // Populate department dropdown for candidate form
    function populateDepartmentDropdown(selectedValue, callback) {
        const deptDropdown = document.getElementById('detail-department');
        if (!deptDropdown) return;

        // Load departments if not already loaded
        if (departmentsData.length === 0) {
            google.script.run
                .withSuccessHandler(function (res) {
                    if (res.success) {
                        departmentsData = res.departments || [];
                        fillDepartmentOptions(deptDropdown, selectedValue);
                        if (callback) callback();
                    }
                })
                .apiGetDepartments();
        } else {
            fillDepartmentOptions(deptDropdown, selectedValue);
            if (callback) callback();
        }
    }

    function fillDepartmentOptions(dropdown, selectedValue) {
        dropdown.innerHTML = '<option value="">Chọn phòng ban</option>';
        departmentsData.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.name;
            option.textContent = dept.name;
            if (dept.name === selectedValue) {
                option.selected = true;
            }
            dropdown.appendChild(option);
        });
    }

    // Populate position dropdown based on selected department
    function populatePositionDropdown(selectedPosition) {
        const deptDropdown = document.getElementById('detail-department');
        const posDropdown = document.getElementById('detail-position');

        if (!deptDropdown || !posDropdown) return;

        const selectedDept = deptDropdown.value;
        posDropdown.innerHTML = '<option value="">Chọn vị trí</option>';

        if (!selectedDept) return;

        const dept = departmentsData.find(d => d.name === selectedDept);
        if (dept && dept.positions) {
            dept.positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                if (pos === selectedPosition) {
                    option.selected = true;
                }
                posDropdown.appendChild(option);
            });
        }
    }

    // ============================================
    // KANBAN FILTER LOGIC
    // ============================================

    let kanbanFilters = {
        search: '',
        department: '',
        position: '',
        recruiter: '',
        dateFrom: '',
        dateTo: ''
    };

    // Populate filter dropdowns
    function populateFilterDropdowns() {
        // Populate department filter
        const deptFilter = document.getElementById('filter-department');
        if (deptFilter && departmentsData.length > 0) {
            deptFilter.innerHTML = '<option value="">Tất cả phòng ban</option>';
            const uniqueDepts = [...new Set(departmentsData.map(d => d.name))];
            uniqueDepts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
        }

        // Populate position filter (all positions from all departments)
        const posFilter = document.getElementById('filter-position');
        if (posFilter && departmentsData.length > 0) {
            posFilter.innerHTML = '<option value="">Tất cả vị trí</option>';
            const allPositions = [];
            departmentsData.forEach(dept => {
                dept.positions.forEach(pos => {
                    if (!allPositions.includes(pos)) {
                        allPositions.push(pos);
                    }
                });
            });
            allPositions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                posFilter.appendChild(option);
            });
        }

        // Populate recruiter filter
        const recruiterFilter = document.getElementById('filter-recruiter');
        if (recruiterFilter && candidatesData.length > 0) {
            recruiterFilter.innerHTML = '<option value="">Người phụ trách</option>';
            const uniqueRecruiters = [...new Set(candidatesData.map(c => c.Recruiter).filter(r => r))];
            uniqueRecruiters.forEach(recruiter => {
                const option = document.createElement('option');
                option.value = recruiter;
                option.textContent = recruiter;
                recruiterFilter.appendChild(option);
            });
        }
    }

    // Apply filters to candidate data
    function applyKanbanFilters() {
        let filtered = [...candidatesData];

        // Filter by search text (name, email, phone)
        if (kanbanFilters.search) {
            const searchLower = kanbanFilters.search.toLowerCase();
            filtered = filtered.filter(c => {
                const name = (c.Name || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower);
            });
        }

        // Filter by department
        if (kanbanFilters.department) {
            filtered = filtered.filter(c => c.Department === kanbanFilters.department);
        }

        // Filter by position
        if (kanbanFilters.position) {
            filtered = filtered.filter(c => c.Position === kanbanFilters.position);
        }

        // Filter by recruiter
        if (kanbanFilters.recruiter) {
            filtered = filtered.filter(c => c.Recruiter === kanbanFilters.recruiter);
        }

        // Filter by date range
        if (kanbanFilters.dateFrom) {
            const fromDate = new Date(kanbanFilters.dateFrom);
            filtered = filtered.filter(c => {
                if (!c.Applied_Date) return false;
                const appliedDate = new Date(c.Applied_Date);
                return appliedDate >= fromDate;
            });
        }

        if (kanbanFilters.dateTo) {
            const toDate = new Date(kanbanFilters.dateTo);
            toDate.setHours(23, 59, 59); // End of day
            filtered = filtered.filter(c => {
                if (!c.Applied_Date) return false;
                const appliedDate = new Date(c.Applied_Date);
                return appliedDate <= toDate;
            });
        }

        return filtered;
    }

    // Attach filter event listeners
    function attachFilterEventListeners() {
        const searchInput = document.getElementById('kanban-search');
        const deptFilter = document.getElementById('filter-department');
        const posFilter = document.getElementById('filter-position');
        const recruiterFilter = document.getElementById('filter-recruiter');
        const dateFromFilter = document.getElementById('filter-date-from');
        const dateToFilter = document.getElementById('filter-date-to');

        if (searchInput) {
            searchInput.addEventListener('input', function () {
                kanbanFilters.search = this.value;
                renderKanbanBoardWithFilters();
            });
        }

        if (deptFilter) {
            deptFilter.addEventListener('change', function () {
                kanbanFilters.department = this.value;
                renderKanbanBoardWithFilters();
            });
        }

        if (posFilter) {
            posFilter.addEventListener('change', function () {
                kanbanFilters.position = this.value;
                renderKanbanBoardWithFilters();
            });
        }

        if (recruiterFilter) {
            recruiterFilter.addEventListener('change', function () {
                kanbanFilters.recruiter = this.value;
                renderKanbanBoardWithFilters();
            });
        }

        if (dateFromFilter) {
            dateFromFilter.addEventListener('change', function () {
                kanbanFilters.dateFrom = this.value;
                renderKanbanBoardWithFilters();
            });
        }

        if (dateToFilter) {
            dateToFilter.addEventListener('change', function () {
                kanbanFilters.dateTo = this.value;
                renderKanbanBoardWithFilters();
            });
        }
    }

    // Render Kanban board with filters applied
    function renderKanbanBoardWithFilters() {
        const originalData = candidatesData;
        candidatesData = applyKanbanFilters();
        renderKanbanBoard();
        candidatesData = originalData; // Restore original data
    }

    // Populate position dropdown for Add Candidate modal
    function populateAddPositionDropdown() {
        const deptDropdown = document.getElementById('add-department');
        const posDropdown = document.getElementById('add-position');

        if (!deptDropdown || !posDropdown) return;

        const selectedDept = deptDropdown.value;
        posDropdown.innerHTML = '<option value="">Chọn vị trí</option>';

        if (!selectedDept) return;

        const dept = departmentsData.find(d => d.name === selectedDept);
        if (dept && dept.positions) {
            dept.positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                posDropdown.appendChild(option);
            });
        }
    }

    // Open Add Candidate modal and populate department dropdown
    function prepareAddCandidateModal() {
        populateDepartmentDropdown(null, function () {
            // Populate for add modal
            const addDeptDropdown = document.getElementById('add-department');
            if (addDeptDropdown && departmentsData.length > 0) {
                addDeptDropdown.innerHTML = '<option value="">Chọn phòng ban</option>';
                departmentsData.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    addDeptDropdown.appendChild(option);
                });
            }
        });
        // Populate status dropdown
        populateAddStatusDropdown('Apply');  // Default to Apply for new candidates
        // Clear form
        document.getElementById('add-candidate-form').reset();
    }

    // Initialize filters when Kanban section loads
    document.addEventListener('DOMContentLoaded', function () {
        attachFilterEventListeners();

        // Populate filters when switching to Kanban section
        const kanbanNavLink = document.querySelector('[href="#kanban"]');
        if (kanbanNavLink) {
            kanbanNavLink.addEventListener('click', function () {
                setTimeout(() => {
                    populateFilterDropdowns();
                }, 300);
            });
        }

        // Prepare Add Candidate modal when opened
        const addCandidateModal = document.getElementById('addCandidateModal');
        if (addCandidateModal) {
            addCandidateModal.addEventListener('show.bs.modal', function () {
                prepareAddCandidateModal();
            });
        }
    });
</script>